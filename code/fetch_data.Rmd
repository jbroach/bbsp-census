---
title: "bbsp-census"
author: "Joe Broach"
date: "April 11, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!require("pacman")) {install.packages("pacman")}; library(pacman)

pacman::p_load(dplyr)
pacman::p_load(tidycensus)
#pacman::p_load(mapview)
#pacman::p_load(sf)
pacman::p_load(stringr)
pacman::p_load(readr)
pacman::p_load(tidyr)
#pacman::p_load("tigris")

```

```{r load data}
getwd()
#setwd("../")
cities <- read.csv("../data/cities1.csv", stringsAsFactors = F)

v17 <- load_variables(2017, "acs5", cache = TRUE)
View(v17)

## setup cenus api key
mykey <- read.table("../secrets/key1.txt", stringsAsFactors = F)[1, 1]
census_api_key(mykey) # read in from untracked file

df <- data.frame(City = c("Portland"), State = c("OR"))
df <- data.frame(City = c("Boise"), State = c("ID"))

f <- function (df, place_type = "city") {
  get_acs(geography = ifelse(place_type == "County", "county", "place"),
          year = 2017, # 2013-2017
          variables = c("B11016_001",
                        "B01003_001",
                        "B19013_001",
                        "B17021_002",
                        "B03002_003",
                        "B03002_012",
                        "C16002_004",
                        "C16002_007",
                        "C16002_010",
                        "C16002_013"),
          state = df$State,
          geometry = F) %>%
  filter(stringr::str_detect(NAME, paste0("^", df$City, " ", place_type)))
    #filter(NAME == paste(df$City, "city"))
}

census_raw <- data.frame()

for (i in 1:nrow(cities)) {
  place = cities[i,]
  print(place$City)
  newrows <- f(place) %>%
    mutate(city = place$City, state = place$State)
  print(nrow(newrows))
  census_raw <- census_raw %>%
    bind_rows(newrows)
  print(nrow(census_raw))
}

result <- by(cities, 1:nrow(cities), f(row))
nrow(census_raw)

write_csv(census_raw, "../output/acs1_long.csv")

census <- census_raw %>% 
  select(-moe) %>%
  spread(key=variable, value=estimate) %>%
  rename(hh = B11016_001, pop = B01003_001,
         medinc_h = B19013_001, pov_p = B17021_002,
         nhwht = B03002_003, hisp = B03002_012) %>%
  mutate(limeng = C16002_004 + C16002_007 + C16002_010 + C16002_013)


#############

mapply(print, cities$City, cities$State)

result <- cities %>% lapply()
get_acs(geography = "place", 
                  year = 2017, # 2013-2017
                  variables = c("B19013_001",
                                "B03002_003"),
                  state = "OR",
                  geometry = F, summary_var = "B01003_001")

v17 <- load_variables(2017, "acs5", cache = TRUE)
View(v17)
tracts <- get_acs(geography = "place", 
                  year = 2017, # 2013-2017
                  variables = c("B19013_001",
                                "B03002_003"),
                  state = "OR",
                  geometry = F, summary_var = "B01003_001")

tracts %>%
  filter(stringr::str_detect(NAME, "Portland city"))
?cat

?get_acs
?filter
?stringr::str_detect

g <- tigris::places("or", cb = T) %>%
  st_as_sf()
mapview(g)
?places
```

```{r other places}
getwd()
acs_wide <- read_csv("../output/acs1_wide.csv") %>%
  select(-(C16002_004:C16002_013))
head(acs_wide)
acs_long <- read.csv("../output/acs1_long.csv", stringsAsFactors = F)
head(acs_long)

# see what's missing
cities <- read_csv("../data/cities.csv")
cities_ck <- cities %>% anti_join(acs_wide, by=c("City" = "city", 
                                                 "State" = "state"))
# Honolulu is a CDP
result <- cities_ck %>%
  filter(City == "Honolulu") %>% 
  mutate(City = "Urban Honolulu") %>%
  f(place_type = "CDP") %>% 
  mutate(city = "Honolulu", state= "HI")
write_csv(result, "../output/other_places//honolulu.csv")

# Boise is Boise City
result <- cities_ck %>%
  filter(City == "Boise") %>% 
  mutate(City = "Boise City") %>%
  f() %>% 
  mutate(city = "Boise", state= "ID")
write_csv(result, "../output/other_places/boise.csv")

# Montgomery is a County
result <- cities_ck %>%
  filter(City == "Montgomery County MD") %>%
  mutate(City = "Montgomery") %>%
  f(place_type = "County") %>% 
  mutate(city = "Montgomery County", state= "MD")
write_csv(result, "../output/other_places/EllicottCity.csv")

# 
result <- cities_ck %>%
  filter(City == "Ellicott City") %>%
  f(place_type = "CDP") %>% 
  mutate(city = "Ellicott City", state= "MD")
write_csv(result, "../output/other_places/montgomeryCO.csv")

# Use county for Nashville
result <- cities_ck %>%
  filter(City == "Nashville") %>%
  mutate(City = "Davidson") %>%
  f(place_type = "County") %>% 
  mutate(city = "Nashville", state= "TN")
write_csv(result, "../output/other_places/Nashville.csv")

#
result <- cities_ck %>%
  filter(City == "Blaine County") %>%
  mutate(City = "Blaine") %>%
  f(place_type = "County") %>% 
  mutate(city = "Blaine County", state= "ID")
write_csv(result, "../output/other_places/BlaineCo.csv")

# 
result <- cities_ck %>%
  filter(City == "College Park, and the campus of the University of Maryland") %>%
    mutate(City = "College Park") %>%
  f() %>%
  mutate(city = "College Park", state= "MD")
write_csv(result, "../output/other_places/CollegePark.csv")

#
result <- cities_ck %>%
  filter(City == "Los Angeles County") %>%
  mutate(City = "Los Angeles") %>%
  f(place_type = "County") %>% 
  mutate(city = "Los Angeles County", state= "CA")
write_csv(result, "../output/other_places/LosAngelesCo.csv")

other_places <- paste0("../output/other_places/", 
                       list.files("../output/other_places/")) %>%
  lapply(read.csv, stringsAsFactors = F) %>%
  bind_rows()  

acs_long <- acs_long %>%
  bind_rows(other_places)

```

```{r multi-city places}
acs_wide <- read_csv("../output/acs1_wide.csv") %>%
  select(-(C16002_004:C16002_013))
head(acs_wide)

# see what's missing
cities <- read_csv("../data/cities.csv")
cities_ck <- cities %>% anti_join(acs_wide, by=c("City" = "city", 
                                                 "State" = "state"))
# Honolulu is a CDP
result <- cities_ck %>%
  filter(City == "Honolulu") %>% 
  mutate(City = "Urban Honolulu") %>%
  f(place_type = "CDP") %>% 
  mutate(city = "Honolulu", state= "HI")
write_csv(result, "../output/other_places//honolulu.csv")

# Boise is Boise City
result <- cities_ck %>%
  filter(City == "Boise") %>% 
  mutate(City = "Boise City") %>%
  f() %>% 
  mutate(city = "Boise", state= "ID")
write_csv(result, "../output/other_places/boise.csv")

# Montgomery is a County
result <- cities_ck %>%
  filter(City == "Montgomery County MD") %>%
  mutate(City = "Montgomery") %>%
  f(place_type = "County") %>% 
  mutate(city = "Montgomery County", state= "MD")
write_csv(result, "../output/other_places/EllicottCity.csv")

# 
result <- cities_ck %>%
  filter(City == "Ellicott City") %>%
  f(place_type = "CDP") %>% 
  mutate(city = "Ellicott City", state= "MD")
write_csv(result, "../output/other_places/montgomeryCO.csv")

# Use county for Nashville
result <- cities_ck %>%
  filter(City == "Nashville") %>%
  mutate(City = "Davidson") %>%
  f(place_type = "County") %>% 
  mutate(city = "Nashville", state= "TN")
write_csv(result, "../output/other_places/Nashville.csv")

#
result <- cities_ck %>%
  filter(City == "Blaine County") %>%
  mutate(City = "Blaine") %>%
  f(place_type = "County") %>% 
  mutate(city = "Blaine County", state= "ID")
write_csv(result, "../output/other_places/BlaineCo.csv")

# 
result <- cities_ck %>%
  filter(City == "College Park, and the campus of the University of Maryland") %>%
    mutate(City = "College Park") %>%
  f() %>%
  mutate(city = "College Park", state= "MD")
write_csv(result, "../output/other_places/CollegePark.csv")

#
result <- cities_ck %>%
  filter(City == "Los Angeles County") %>%
  mutate(City = "Los Angeles") %>%
  f(place_type = "County") %>% 
  mutate(city = "Los Angeles County", state= "CA")
write_csv(result, "../output/other_places/LosAngelesCo.csv")

other_places <- paste0("../output/other_places/", 
                       list.files("../output/other_places/")) %>%
  lapply(read.csv, stringsAsFactors = F) %>%
  bind_rows()  

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
